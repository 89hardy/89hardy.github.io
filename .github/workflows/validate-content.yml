name: Validate Content

on:
  pull_request:
    paths:
      - '_posts/**'
      - '_drafts/**'
  push:
    branches:
      - claude/**
    paths:
      - '_posts/**'
      - '_drafts/**'

jobs:
  validate-posts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            _posts/**
            _drafts/**

      - name: Validate post frontmatter
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Validating changed posts..."

          # Required frontmatter fields
          required_fields=("layout" "title" "date")

          # Track validation errors
          errors=0

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo ""
            echo "Checking: $file"

            # Check if file exists (could be deleted)
            if [ ! -f "$file" ]; then
              echo "  ℹ️  File deleted, skipping"
              continue
            fi

            # Extract frontmatter
            frontmatter=$(awk '/^---$/{i++}i==1' "$file" | head -n -1)

            if [ -z "$frontmatter" ]; then
              echo "  ❌ No frontmatter found"
              errors=$((errors + 1))
              continue
            fi

            # Check required fields
            for field in "${required_fields[@]}"; do
              if ! echo "$frontmatter" | grep -q "^${field}:"; then
                echo "  ❌ Missing required field: $field"
                errors=$((errors + 1))
              else
                echo "  ✓ Has field: $field"
              fi
            done

            # Validate date format in filename for posts
            if [[ "$file" =~ ^_posts/ ]]; then
              filename=$(basename "$file")
              if [[ ! "$filename" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
                echo "  ❌ Invalid filename format. Should start with YYYY-MM-DD-"
                errors=$((errors + 1))
              else
                echo "  ✓ Valid filename format"
              fi
            fi

            # Check for empty title
            title=$(echo "$frontmatter" | grep "^title:" | sed 's/^title: *//')
            if [ -z "$title" ] || [ "$title" = '""' ] || [ "$title" = "''" ]; then
              echo "  ❌ Title is empty"
              errors=$((errors + 1))
            fi
          done

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ $errors -eq 0 ]; then
            echo "✅ All posts validated successfully!"
            exit 0
          else
            echo "❌ Validation failed with $errors error(s)"
            exit 1
          fi

  spellcheck:
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail the build on spelling errors

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            _posts/**
            _drafts/**

      - name: Spellcheck
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: rojopolis/spellcheck-github-actions@0.36.0
        with:
          config_path: .github/spellcheck-config.yml
          task_name: Markdown
        continue-on-error: true
